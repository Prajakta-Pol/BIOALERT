<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patient Dashboard - BioMediAlert</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #dbeafe, #e3f2fd, #f5f9ff);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    .profile-photo-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #0a3d62;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profile-photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade { animation: fadeIn 0.7s ease-in-out; }

    .floating { animation: float 6s ease-in-out infinite; }
    @keyframes float {
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-10px); }
    }
  </style>
</head>

<body class="relative text-gray-800">

  <!-- Floating Orbs -->
  <div class="absolute w-[400px] h-[400px] bg-blue-400/20 rounded-full blur-3xl top-10 left-6 floating"></div>
  <div class="absolute w-[350px] h-[350px] bg-teal-400/20 rounded-full blur-3xl bottom-10 right-6 floating"></div>

  <!-- Navbar -->
 <nav class="glass flex items-center px-8 py-4 shadow-md sticky top-0 z-20 border-b border-white/40">

  <!-- Left -->
  <div class="flex-1">
    <a href="dashboard.html"
       class="text-2xl font-bold text-[#0a3d62] tracking-wide 
       hover:scale-105 transition-transform duration-300 
       inline-block cursor-pointer select-none">
       BioMediAlert
    </a>
  </div>

  <!-- Center -->
  <div class="flex-1 text-center">
    <p id="showEmergencyID" class="text-lg font-semibold text-blue-600"></p>
  </div>

  <!-- Right -->
  <div class="flex-1 flex justify-end items-center space-x-4">
    <button onclick="openQRPopup()" 
      class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
      Show QR
    </button>

    <a href="./dashboard.html" onclick="logout()" 
      class="hover:text-blue-600 font-medium transition text-[#0a3d62] cursor-pointer">
      Logout
    </a>
  </div>

</nav>

  <!-- Welcome Card -->
  <div class="flex items-center justify-center mt-12 animate-fade">
    <div class="glass flex items-center gap-6 p-6 rounded-2xl shadow-lg w-[90%] max-w-2xl border border-white/50 hover:shadow-2xl transition">
      
       <div class="profile-photo-container">
        <img id="profile" src="" alt="Patient Photo">
      </div>
      <div>
        <h2 id="FullNameDisplay" class="text-2xl font-semibold text-[#0a3d62]">Full Name</h2>
        <p id="welcome" class="text-gray-600 mt-1">Welcome back, stay healthy ðŸ’™</p>
      </div>

    </div>
  </div>

  <!-- BLOCKS SECTION ONLY -->
  <section class="mx-auto mt-14 px-6 md:px-16 max-w-5xl animate-fade">
    <h2 class="text-3xl font-bold text-[#0a3d62] mb-3">Patient Dashboard</h2>
    <p class="text-gray-700 mb-8 text-lg">Manage your health data with ease.</p>

    <div class="grid md:grid-cols-2 gap-6">

      <!-- My Profile Block -->
      <div class="glass rounded-2xl p-6 shadow-md hover:shadow-xl transition border border-white/50">
        <h3 class="text-xl font-semibold text-[#0a3d62] mb-2">ðŸ‘¤ My Profile</h3>
        <p class="text-gray-600 mb-4">View and update your personal info and medical details.</p>
        <a href="patientProfile.html"
           class="bg-[#0a3d62] hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition">
          View Profile
        </a>
      </div>

      <!-- Treatment Logs Block -->
      <div class="glass rounded-2xl p-6 shadow-md hover:shadow-xl transition border border-white/50">
        <h3 class="text-xl font-semibold text-[#0a3d62] mb-2">ðŸ§¾ Treatment Logs</h3>
        <p class="text-gray-600 mb-4">See which doctors have accessed your records.</p>
        <a href="PatientLogs.html"
           class="bg-[#0a3d62] hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg font-medium shadow-md transition">
          View Logs
        </a>
      </div>

    </div>
  </section>

  <!-- QR POPUP -->
  <div id="qrPopup" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
    <div class="glass p-6 rounded-2xl shadow-xl w-96 text-center">

      <h2 class="text-2xl font-semibold mb-4 text-[#0a3d62]">Emergency QR</h2>

      <div id="qrResult" class="my-4"></div>

      <button id="downloadQR" onclick="downloadQR()" 
        class="hidden bg-green-600 text-white w-full py-2 rounded-lg">
        Download QR
      </button>

      <button onclick="closeQRPopup()" class="mt-3 text-red-600 font-semibold">Close</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-16 text-center py-6 bg-[#0a3d62] text-white shadow-inner">
    <p class="text-sm opacity-90">Â© 2025 <span class="font-semibold">BioMediAlert</span> â€” All Rights Reserved</p>
  </footer>

  <!-- JS -->
  <script>
    // Load Profile Info
    async function loadDashboard() {
      try {
        const res = await fetch("http://127.0.0.1:5037/api/patient/details");
        const data = await res.json();

        
        if (!data.error) {
          document.getElementById("FullNameDisplay").innerText = data.Fullname;
          document.getElementById("welcome").innerText = `Welcome back, ${data.Fullname}!`;
          document.getElementById("showEmergencyID").textContent =
        "Emergency ID: " + data.emergency_id;

          const profileImg = document.getElementById("profile");

          if (data.photo) {
            profileImg.src = "http://127.0.0.1:5037" + data.photo;
          } else {
            profileImg.src = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
          }

        } else {
          alert("Please login again.");
          window.location.href = "Login.html";
        }
      } catch (err) {
        console.error("Error loading dashboard:", err);
      }
    }
    loadDashboard();


    // QR Popup
    async function openQRPopup() {
      document.getElementById("qrPopup").classList.remove("hidden");
      document.getElementById("qrResult").innerHTML = "";
      document.getElementById("downloadQR").classList.add("hidden");

    try {
      // ðŸ”¹ Fetch emergency ID from backend
      const res = await fetch("http://127.0.0.1:5037/api/patient/details");
      const data = await res.json();

      if (!data.emergency_id) {
        alert("Emergency ID not found");
        return;
      }

      // ðŸ”¹ Display QR immediately (NO generation button needed)
      new QRCode(document.getElementById("qrResult"), {
        text: data.emergency_id,
        width: 200,
        height: 200,
      });

      document.getElementById("downloadQR").classList.remove("hidden");
    } catch (err) {
      console.error("QR fetch error:", err);
      alert("Failed to load Emergency QR");
    }
  }

  function closeQRPopup() {
    document.getElementById("qrPopup").classList.add("hidden");
    document.getElementById("qrResult").innerHTML = "";
    document.getElementById("downloadQR").classList.add("hidden");
  }

  // QR Download
  function downloadQR() {
    const canvas = document.querySelector("#qrResult canvas");
    if (!canvas) return;

    const link = document.createElement("a");
    link.download = "EmergencyQR.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }
  </script>

</body>
</html>