<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - BioMediAlert</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg,#dbeafe,#e3f2fd,#f5f9ff);
      min-height:100vh;
    }

    .glass {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(20px);
      border-radius:20px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body class="text-gray-800">

<!-- NAVBAR -->
<nav class="glass flex justify-between items-center px-8 py-4 sticky top-0 z-50">
  <div class="text-2xl font-bold text-[#0a3d62]">
    BioMediAlert ‚Äî Admin Panel
  </div>
  <button onclick="logout()" class="text-[#0a3d62] font-medium hover:text-red-600">
    Logout
  </button>
</nav>

<!-- SYSTEM OVERVIEW -->
<section class="max-w-6xl mx-auto mt-10 px-6">
  <h2 class="text-3xl font-bold text-[#0a3d62] mb-6">System Overview</h2>

  <div class="grid md:grid-cols-4 gap-6">
    <div class="glass p-6 text-center">
      <h3 class="text-lg font-semibold">üöë Emergencies</h3>
      <p id="emergencyCount" class="text-3xl font-bold text-red-600 mt-2">0</p>
    </div>

    <div class="glass p-6 text-center">
      <h3 class="text-lg font-semibold">üë®‚Äç‚öïÔ∏è Doctors</h3>
      <p id="doctorCount" class="text-3xl font-bold text-blue-600 mt-2">0</p>
    </div>

    <div class="glass p-6 text-center">
      <h3 class="text-lg font-semibold">üë§ Patients</h3>
      <p id="patientCount" class="text-3xl font-bold text-green-600 mt-2">0</p>
    </div>

    <div class="glass p-6 text-center">
      <h3 class="text-lg font-semibold">‚ö†Ô∏è Overrides</h3>
      <p id="overrideCount" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
    </div>
  </div>
</section>


<!-- DOCTOR VERIFICATION -->
<section class="max-w-6xl mx-auto mt-14 px-6">
  <h2 class="text-2xl font-bold text-[#0a3d62] mb-4">Doctor & Hospital Verification</h2>

  <div class="glass p-6">
    <table class="w-full">
      <thead class="border-b">
        <tr>
          <th>Doctor Name</th>
          <th>License No</th>
          <th>Hospital</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="doctorVerificationTable"></tbody>
    </table>
  </div>
</section>

<!-- ACCESS LOGS -->
<section class="max-w-6xl mx-auto mt-14 px-6">
  <h2 class="text-2xl font-bold text-[#0a3d62] mb-4">Access Logs & Audit Trail</h2>

  <div class="glass p-6">
    <ul id="auditLogs" class="space-y-4"></ul>
  </div>
</section>

<!-- CONSENT OVERVIEW -->
<section class="max-w-6xl mx-auto mt-14 px-6 mb-20">
  <h2 class="text-2xl font-bold text-[#0a3d62] mb-4">Patient Consent Overview</h2>

  <div class="glass p-6">
    <p class="text-gray-700">
      ‚úî Emergency Override Allowed:
      <span class="font-semibold text-green-600">Yes</span><br>
      ‚ùå Override Denied:
      <span class="font-semibold text-red-600">No</span>
    </p>
  </div>
</section>

<!-- FOOTER -->
<footer class="bg-[#0a3d62] text-white text-center py-6">
  ¬© 2025 BioMediAlert ‚Äî Admin Control Panel
</footer>

<script>

// üîí Mask Aadhaar Function
function maskAadhaar(value) {
  if (!value) return "";
  const str = value.toString();
  if (str.length <= 4) return str;
  return "********" + str.slice(-4);
}

async function loadAdminLogs() {
  try {
    const res = await fetch("http://127.0.0.1:5037/api/admin/logs");
    const data = await res.json();
    const logs = data.logs;

    const auditList = document.getElementById("auditLogs");
    auditList.innerHTML = "";

    let emergencyCount = 0;
    let overrideCount = 0;
    const doctorSet = new Set();
    const patientSet = new Set();

    logs.forEach(log => {

      doctorSet.add(log.doctor_license);
      patientSet.add(log.patient_aadhaar);

      if (log.access_method === "emergency") emergencyCount++;
      if (log.action === "override") overrideCount++;

      const li = document.createElement("li");
      li.className = "border-b pb-3";

      li.innerHTML = `
        <div>
          <strong>${log.doctor_name || log.doctor_license}</strong>
          accessed patient
          <strong>${maskAadhaar(log.patient_aadhaar)}</strong>
        </div>
        <div class="text-sm text-gray-500 mt-1">
          ${log.access_method || "normal"} | ${log.reason || "N/A"}<br>
          ‚õì Tx: ${log.blockchain_tx || "Not recorded"}<br>
          üïí ${log.date} ${log.time}
        </div>
      `;

      auditList.appendChild(li);
    });

    document.getElementById("emergencyCount").innerText = emergencyCount;
    document.getElementById("overrideCount").innerText = overrideCount;
    document.getElementById("doctorCount").innerText = doctorSet.size;
    document.getElementById("patientCount").innerText = patientSet.size;

  } catch (err) {
    console.error("Failed to load logs", err);
  }
}

async function loadDoctors() {
  try {
    const res = await fetch("http://127.0.0.1:5037/api/admin/doctors");
    const data = await res.json();
    const table = document.getElementById("doctorVerificationTable");

    table.innerHTML = "";

    data.doctors.forEach(doc => {

      const statusColor =
        doc.status === "VERIFIED" ? "text-green-600" :
        doc.status === "BLOCKED" ? "text-red-600" :
        "text-yellow-600";

      table.innerHTML += `
        <tr class="border-b">
          <td>${doc.name}</td>
          <td>${doc.license}</td>
          <td>${doc.hospital}</td>
          <td class="font-semibold ${statusColor}">${doc.status}</td>
          <td>
            <button onclick="verifyDoctor('${doc.license}')" class="bg-blue-600 text-white px-3 py-1 rounded">Verify</button>
            <button onclick="blockDoctor('${doc.license}')" class="bg-gray-600 text-white px-3 py-1 rounded ml-2">Block</button>
          </td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("Failed to load doctors", err);
  }
}

async function verifyDoctor(licenseNo) {
  await fetch("http://127.0.0.1:5037/api/admin/verify_doctor", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ licenseNo })
  });
  loadDoctors();
}

async function blockDoctor(licenseNo) {
  await fetch("http://127.0.0.1:5037/api/admin/block_doctor", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ licenseNo })
  });
  loadDoctors();
}

function logout() {
  localStorage.removeItem("currentAdmin");
  window.location.href = "dashboard.html";
}

loadAdminLogs();
loadDoctors();

</script>

</body>
</html>